# webd

Система учета и демонстрации курсовых и выпускных работ.
Разработана для кафедры Информатики и Математического Обеспечения
Петрозаводского государственного университета.

Концептуально, это система с базой данных на основе файловой системы:
документы пользователей (студентов) хранятся в индивидуальных каталогах.
В этих же каталогах сам пользователь сопровождает так называемый индекс-файл,
в котором содержатся необходимые данные о студенте.

Система имеет web-интерфейс с возможностью работы из Clojure REPL.

## Индекс-файлы

Индекс файл должен содержать информацию о студенте, которая помогает в 
учете его работы. Такой файл может быть оформлен в форматах
XML, JSON, Clojure EDN и называться `index` с соответствующим расширением.
Имя файла и учитываемые расширения можно указать в конфигурационном файле.

Файлы должны содержать следующие текстовые поля (список может изменяться):

name - ФИО студента
title - название работы
adviser-name - ФИО научного руководителя
adviser-status - звание научного руководителя
department - кафедра

Для XML-файла эти элементы должны быть вложены в элемент `diploma`.
Кроме того, `adviser-name` (в XML - просто `name`) и `-status` (просто `status`)
должны быть вложены в элемент `adviser`.
Схему можно попробовать найти по адресу http://www.cs.karelia.ru/style/diploma.xsd.

Для EDN формата корневым элементом должна быть Map (`{...}`), ключи в которой
должны быть keyword, а строки заключены в кавычки.

Для JSON корнем должен быть объект (также `{...}`), а ключи и значения - 
строками в кавычках.

Список допустимых значений поля `department` задается в конфигурационном файле.

## Конфигурация

Конфигурационный файл находится в config/config.clj.
Там находится конфигурация по умолчанию, а все параметры подписаны.

Файл позволяет изменять учитываемую структуры внутри каталога с 
базой данных системы, например задавать уровни вложенности каталогов.
Тем не менее, изменение не тестировалось, поэтому не рекомендуется убирать
имеющиеся основные роли папок: groups, years, courses, logins.
Последнюю роль рекомендуется также сохранять logins.

В файле `src/webd/core.clj` можно изменить имя конфигурационного файла, 
полезно например для локального тестирования.

## Авторизация и личный кабинет

Система имеет возможность управлять файлами пользователя из
web-интерфейса из личного кабинета. Реализована авторизация с помощью LDAP
с сервера кафедры, таким образом в web-интерфейсе доступен вход для
пользователей, определенных в файловой системе.

В личном кабинете пользователь может изменять личную информацию,
а также просматривать, добавлять и удалять файлы документов
(это предварительные и финальные варианты работы и презентации).

Если авторизовавшийся через LDAP человек - не студент (у него нет
соответствующих полей в LDAP, таких как dn:"ou=students", то у него
не будет доступа к регистрации работы, но будет доступ к просмотру
и поиску существующих работ. У преподавателей будет доступна
дополнительная страница со всеми их студентами (`/query-adviser`).

Есть возможность авторизоваться от лица любого пользователя
с общим паролем (см пароль в `src/webd/auth.clj). Тогда пользователь
будет считаться администратором. Посмотреть чужие логины можно
на таблице с результатами поиска, тултип при наведении на ФИО.

## Генерация документов

По результатам запроса по базе данных можно генерировать PDF-документ,
содержащий таблицу, аналогичную той, что в web-интерфейсе.
Порядок колонок, их ширину и подписи можно изменить в конфигурационном файле.

## Структура кода

* src/webd
  * core.clj - контроллеры и инициализация приложения
  * ui.clj - инициализация вьюшек
  * auth.clj - авторизация и аутентификация через LDAP, а также некоторые
функции по работе с LDAP (запрос данных о пользователе)
  * parsing.clj - работа с файлами (парсинг файлов, запросы, кеширование)
  * files.clj - работа с ФС (сохранение, удаление, инициализация папок)
  * doc.clj - генератор PDF отчетов
* resources
  * шаблоны вьюшек, шрифты, css и js файлы
* config
  * конфиги приложения и log4j

## Логгирование

Система поддерживает лог-файлы в двух местах: лог-папке сервера tomcat
и в корневой папке системы (или откуда система запускается, если не с помощью
leiningen). На момент написания логи были доступны в `/var/log/tomcat` на сервере zeta.

## Размещение и запуск

Система проектировалась для работы на сервере Tomcat, однако может работать
на других. Например, локально запустить ее можно с помощью команды
	$ lein ring server-headless
после чего веб-интерфейс будет доступен по адресу (по умолчанию) http://localhost:3000.

Для Leiningen также доступна команда 

`$ lein make-webd`

С помощью нее создается uberwar архив с названием `webd` в папке `target`.
После этого надо кинуть архив в директорию с веб-приложениями Tomcat.
На момент написания это `/srv/www/webapps` на сервере zeta.
После закидывания в папку tomcat через какое-то время (секунд 20) обновит и перезапустит 
приложение.

## Советы и детали по работе с приложением

- Если студент не был еще зарегистрирован на текущий год, то при первом логине
для него создастся папка в соответствующем каталоге
- ВАЖНО: в начале каждого года LDAP должен быть актуализирован (студенты переведены на 
следующий год), иначе будет проходить регистрация по данным прошлого года
  (студенты создадутся с предыдущим курсом). После актуализации LDAP нужно обновить 
параметр `:current-year` в `config.clj` и передеплоить приложение
- Если студент создался неправильно (или его данные изменились, например перевелся
в другую группу), то нужно сначала обновить данные в LDAP, а потом или удалить каталог
студента и попросить его зарегаться заново (или зарегать его самому), или переместить его
папку в правильную
- студенты могут сами заходить в свои прошлые года и там изменять данные о работе,
но это не совсем публичная возможность (нигде нет ссылок). Инструкция по редактированию
доступна на главной странице (только для авторизованных)
- Админ может удалить или добавить пользователя через эндпоинты `/user-init` и `/user-delete`, 
см. `src/webd/core.clj`
- имеет смысл иногда обновлять зависимости, помогает плагин lein-ancient

## Лицензия

Copyright © 2015 Кафедра ИМО ПетрГУ

Distributed under the Eclipse Public License either version 1.0 or (at
your option) any later version.
